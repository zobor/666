<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEMO</title>
<style>
* {margin: 0;padding:0; color: #000;}
#app {
  position: absolute;
  background: #efefef;
  top: 0;
  left: 0;
  width: 96vw;
  height: 90vh;
}
#tb {
  position: absolute;
  top: 10px;
  right: 10px;
}
#tb ul {
  float: right;
  font-size: 13px;
  list-style: none;
  line-height: 1;
}
#tb li.max {
  color: red;
}
#tb li.min {
  color: green;
}
#filter-list {
  position: absolute;
  top: 10px;
  left: 2px;
  z-index: 100;
}
#filter-list li {
  padding: 3px 10px;
  background: #000;
  color: #fff;
  cursor: pointer;
}
#filter-list li.active {
  background: red;
}
</style>
</head>
<body>
<div id="app"></div>
<div id="tb"></div>
<ul id="filter-list">
  <li>1</li>
  <li>2</li>
  <li>3</li>
  <li>5</li>
</ul>
<script src="../lib/echarts.min.js"></script>
<script type="module">
import { classnames, getUrlParam, getMinutesKline, getMACD, numVsNum, message, float2Fix, getZhuliRealIn, moneyFormat, loadIndex, gethk2china } from '../src/utils.js';

const myChart = echarts.init(document.getElementById('app'));
const myTable = document.querySelector('#tb');
const $filter = document.querySelector('#filter-list');
let filter = '';

const update = async() => {
  const code = getUrlParam('c') || 'sz000333';
  const rs = await getMinutesKline(code);
  const prices = {};
  let { list } = rs;
  list = list.slice(0, 30);
  list.forEach(item => {
    prices[item.time] = item.close;
  });
  const priceList = list.map(item => item.close);
  const closeList = priceList.reverse();
  const datas = getMACD(closeList);
  const { macd, dif, dea } = datas;

  let dataList = [];
  window.aa = dataList;
  const fixedLength = 4;

  macd.map((item, idx) => {
    if (list[idx].time === '09:30') {
      return;
    }

    const time = list[idx].time;
    const close = prices[time];
    dataList.push({
      macd: Number(item.toFixed(fixedLength)),
      dif: Number(dif[idx].toFixed(fixedLength)),
      dea: Number(dea[idx].toFixed(fixedLength)),
      time,
      close,
    });
  });

  const xData = [];
  const yData = [];
  const yData2 = [];
  const yData3 = [];
  const yData4 = [];
  const zoom = 100 * 1.2;
  dataList.filter(item => {
    if (!filter) {
      return true;
    }
    const { time } = item;
    const min = +time.replace(/\d+:/, '');
    return min % Number(filter) === 0;
  }).reverse().forEach(item => {
    xData.push(item.time);
    yData.push(item.macd * zoom);
    yData2.push(item.dif * zoom);
    yData3.push(item.dea * zoom);
    yData4.push(item.close);
  });
  window.aa = dataList;
  document.title = dataList[0].macd.toFixed(3) + '-' + dataList[0].close;

  const options = getOptions({xData, yData, yData2, yData3, yData4});
  myChart.setOption(options);
  buildTable(dataList);
}

const buildTable = (list) => {
  const table = ['<ul>'];
  const arr = list.reverse().slice(list.length - 26, list.length).reverse();
  const values = arr.map(item => item.close);
  const max = Math.max.apply(Math, values);
  const min = Math.min.apply(Math, values);
  arr.map(item => {
    table.push(`<li class="${item.close === max ? 'max' : item.close === min ? 'min' : ''}">${item.time} - ${item.close}</li>`);
  });
  table.push(`<li>${float2Fix((max - min) / min)}</li>`);
  table.push('</ul>');
  myTable.innerHTML = table.join('');
};

const colors = [
  'rgb(245, 183, 177)',
  'rgb(118, 215, 196)',
  'rgb(171, 178, 185)',
  'rgb(246, 221, 204)',
  '#efefef'
]

function getOptions(params = {}) {
  const { xData, yData,yData2, yData3, yData4 } = params;
  const option = {
    title: {},
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      },
      formatter: function(data) {
        return data[0].axisValue;
      }
    },
    xAxis: {
      data: xData,
    },
    yAxis: {},
    series: [
      {
        name: 'A',
        type: 'line',
        data: yData,
        showSymbol: false,
        itemStyle: {
          normal: {
            color: colors[0],
            borderColor: colors[0],
            borderWidth: 2,
          },
        },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            {
              offset: 0,
              color: colors[3],
            },
            {
              offset: 1,
              color: colors[4],
            },
          ]),
        },
      },
      {
        name: 'B',
        type: 'line',
        data: yData2,
        showSymbol: false,
        itemStyle: {
          normal: {
            color: colors[1],
            borderColor: colors[1],
            borderWidth: 2,
          },
        },
      },
      {
        name: 'C',
        type: 'line',
        data: yData3,
        showSymbol: false,
        itemStyle: {
          normal: {
            color: colors[2],
            borderColor: colors[2],
            borderWidth: 2,
          },
        },
      },
    ]
  };

  return option;
}

$filter.addEventListener('click', e => {
  const { target } = e;
  if (target.tagName.toLowerCase() === 'li') {
    const txt = target.innerText;
    filter = txt.trim();
    update();
    Array.from(target.parentNode.children).forEach(item => {
      item.className = '';
    });
    target.classList.add('active');
  }
});

(async() => {
	await update();
	setInterval(async() => {
		await update();
	}, 2500);
})();
</script>
</body>
</html>